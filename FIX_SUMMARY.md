# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–í –±–æ—Ç–µ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ 0 –∑–∞–∫–∞–∑–æ–≤, —Ö–æ—Ç—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–ª –∑–∞–∫–∞–∑—ã. API –ø–∞—Ä–∫–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

## –ê–Ω–∞–ª–∏–∑

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –±–∞–≥–∏:

1. **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì –≤ bot.py (—Å—Ç—Ä–æ–∫–∞ 271):**
   ```python
   referrer_id=None  # ‚ùå –û–±–Ω—É–ª—è–ª–æ—Å—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É–∂–µ –≤ –ø–∞—Ä–∫–µ!
   ```
   
   **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ, –ù–ï –¥–æ–±–∞–≤–ª—è–ª–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `referrals`
   - `order_checker.py` –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª –∏—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–∫–∞–∑–æ–≤
   - –ó–∞–∫–∞–∑—ã –ù–ï –ø—Ä–æ–≤–µ—Ä—è–ª–∏—Å—å –≤–æ–æ–±—â–µ

2. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ yandex_park_api.py:**
   - –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –±—ã–ª 1 –≥–æ–¥ ‚Üí —Å—Ç–∞—Ä—ã–µ –∑–∞–∫–∞–∑—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å
   - –õ–∏–º–∏—Ç 500 –±–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ ‚Üí –∑–∞–∫–∞–∑—ã >500 —Ç–µ—Ä—è–ª–∏—Å—å
   - –ù–µ—Ç fallback-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Üí –ø—Ä–∏ –æ—à–∏–±–∫–µ API –≤–æ–∑–≤—Ä–∞—â–∞–ª None

3. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–Ω—è—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. bot.py - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è referrer_id

**–ë—ã–ª–æ:**
```python
referrer_id=None,  # –ù–µ —É—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –ø–∞—Ä–∫–µ
```

**–°—Ç–∞–ª–æ:**
```python
referrer_id=referrer_id,  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –ø–∞—Ä–∫–µ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å referrer_id –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ç–∞–±–ª–∏—Ü—É `referrals` –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –∑–∞–∫–∞–∑—ã.

### 2. yandex_park_api.py - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –º–µ—Ç–æ–¥ get_driver_orders_count

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç —É–≤–µ–ª–∏—á–µ–Ω —Å 1 –≥–æ–¥–∞ –¥–æ 5 –ª–µ—Ç
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è (–¥–æ 50 —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ 500 –∑–∞–∫–∞–∑–æ–≤)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω fallback-–º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ `booked_at` –µ—Å–ª–∏ `ended_at` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[ORDERS_CHECK]`
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ driver_id –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞ API –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤

**–õ–æ–≥–∏–∫–∞:**
```
1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–∫–∞–∑—ã —Å ended_at –∑–∞ 5 –ª–µ—Ç
2. –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é (–¥–æ 50 —Å—Ç—Ä–∞–Ω–∏—Ü)
3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí –ø—Ä–æ–±—É–µ–º fallback —á–µ—Ä–µ–∑ booked_at
4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤
```

### 3. order_checker.py - –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª–µ–Ω fallback

**–£–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏ `[CHECK_CYCLE]`, `[CHECK_N]`
- ‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ `get_all_park_users_for_order_check()` –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–µ –Ω–∞—à–µ–ª –∑–∞–ø–∏—Å–µ–π
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–æ 1.5 —Å–µ–∫

### 4. –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã:

- **DEPLOY_CHECKLIST.md** - —á–µ–∫-–ª–∏—Å—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ VPS —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ
- **test_orders_api.py** - —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ API
- **FIX_SUMMARY.md** - —ç—Ç–æ—Ç —Ñ–∞–π–ª

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ VPS

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç:
```bash
cd tgbotkworkAlexzandr83
python3 test_orders_api.py
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞—Ä–∫–µ –∏ –ø–æ–∫–∞–∂–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤.

### –ó–∞–ø—É—Å–∫ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏ —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f order_checker.py

# 2. –ó–∞–ø—É—Å—Ç–∏ —Å –Ω–æ–≤—ã–º –ª–æ–≥–æ–º
python3 order_checker.py 2>&1 | tee -a order_checker_new.log
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞:

1. –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ ‚Üí "‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" ‚Üí "üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É"
2. –í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ > 0

## –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞:
```
[CHECK_CYCLE] Starting order check cycle...
[CHECK_CYCLE] –ë—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
[CHECK_1/5] –ü—Ä–æ–≤–µ—Ä—è–µ–º user_id=123, driver_id=abc123
[ORDERS_CHECK] –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è driver_id=abc123
[ORDERS_CHECK] Driver abc123, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –ø–æ–ª—É—á–µ–Ω–æ 45 –∑–∞–∫–∞–∑–æ–≤ –∏–∑ API
[ORDERS_CHECK] Driver abc123: –ò–¢–û–ì–û –∑–∞–∫–∞–∑–æ–≤ = 45
[CHECK_1/5] ‚úì Driver abc123: –ø–æ–ª—É—á–µ–Ω–æ 45 –∑–∞–∫–∞–∑–æ–≤
```

### –ü—Ä–æ–±–ª–µ–º–∞:
```
[ORDERS_CHECK] Driver abc123: API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ!
```
‚Üí –ü—Ä–æ–≤–µ—Ä—å driver_id –≤ –ë–î –∏ –ø—Ä–∞–≤–∞ API –∫–ª—é—á–∞

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –í—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0 –∑–∞–∫–∞–∑–æ–≤

**–ü—Ä–æ–≤–µ—Ä—å:**
1. –ï—Å—Ç—å –ª–∏ driver_id –≤ –ë–î:
   ```bash
   sqlite3 bot.db "SELECT user_id, yandex_driver_id FROM users WHERE phone_number = '+79XXXXXXXXX'"
   ```

2. –ï—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å –≤ referrals:
   ```bash
   sqlite3 bot.db "SELECT * FROM referrals WHERE referred_id = USER_ID"
   ```

3. –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ API:
   ```bash
   python3 test_orders_api.py
   ```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- –£ –≤–æ–¥–∏—Ç–µ–ª—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ 5 –ª–µ—Ç
- driver_id –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (–ø—Ä–æ–≤–µ—Ä—å –≤ –ë–î)
- –£ API –∫–ª—é—á–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ (–ø—Ä–æ–≤–µ—Ä—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–∞—Ä–∫–∞)

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –°—Ç–∞—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è

–î–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω—É–∂–Ω–æ:
1. –õ–∏–±–æ —É–¥–∞–ª–∏—Ç—å –∏—Ö –∏–∑ –ë–î –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ
2. –õ–∏–±–æ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ referrals:
   ```sql
   INSERT INTO referrals (referrer_id, referred_id, park_position) 
   VALUES (REFERRER_ID, REFERRED_ID, 'express');
   ```

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º —É–±–µ–¥–∏—Å—å:
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω bot.py (referrer_id –Ω–µ –æ–±–Ω—É–ª—è–µ—Ç—Å—è)
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω yandex_park_api.py (–ø–∞–≥–∏–Ω–∞—Ü–∏—è + fallback)
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω order_checker.py (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + fallback)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω test_orders_api.py –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
- [ ] –ó–∞–ø—É—â–µ–Ω –Ω–∞ VPS –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–æ—Ç–∞

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2024-11-20  
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:** bot.py, yandex_park_api.py, order_checker.py  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é –Ω–∞ VPS

