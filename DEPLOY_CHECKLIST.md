# –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ VPS

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### üî¥ –ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ê)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–∫–∞–∑—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ 0, —Ö–æ—Ç—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–µ–ª–∞–ª–∏ –∑–∞–∫–∞–∑—ã.

**–ü—Ä–∏—á–∏–Ω–∞:** –í `bot.py` —Å—Ç—Ä–æ–∫–∞ 271 –æ–±–Ω—É–ª—è–ª–∞ `referrer_id` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –ø–∞—Ä–∫–µ. –ò–∑-–∑–∞ —ç—Ç–æ–≥–æ:
1. –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É `referrals` –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å
2. `order_checker.py` –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª —ç—Ç–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
3. –ó–∞–∫–∞–∑—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∏—Å—å –≤–æ–æ–±—â–µ

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
1. ‚úÖ `bot.py` - —Ç–µ–ø–µ—Ä—å `referrer_id` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–∞–∂–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞—Ä–∫–µ
2. ‚úÖ `yandex_park_api.py` - —É–ª—É—á—à–µ–Ω –º–µ—Ç–æ–¥ `get_driver_orders_count`:
   - –£–≤–µ–ª–∏—á–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω —Å 1 –≥–æ–¥–∞ –¥–æ 5 –ª–µ—Ç
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è (–¥–æ 50 —Å—Ç—Ä–∞–Ω–∏—Ü)
   - –î–æ–±–∞–≤–ª–µ–Ω fallback-–º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ `booked_at`
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
3. ‚úÖ `order_checker.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î (–µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
```bash
cd tgbotkworkAlexzandr83
python3 << EOF
from database import Database
db = Database()

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞—Ä–∫–µ
conn = db.get_connection()
cursor = conn.cursor()

print("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –ø–∞—Ä–∫–µ:")
cursor.execute("SELECT user_id, phone_number, yandex_driver_id, referrer_id FROM users WHERE is_registered_in_park = 1")
for row in cursor.fetchall():
    print(f"  user_id={row[0]}, phone={row[1]}, driver_id={row[2]}, referrer_id={row[3]}")

print("\n–ó–∞–ø–∏—Å–∏ –≤ referrals:")
cursor.execute("SELECT referrer_id, referred_id, orders_count FROM referrals")
for row in cursor.fetchall():
    print(f"  referrer={row[0]}, referred={row[1]}, orders={row[2]}")

conn.close()
EOF
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ order_checker
```bash
cd tgbotkworkAlexzandr83
python3 order_checker.py
```

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ª–æ–≥–µ:**
```
[CHECK_CYCLE] Starting order check cycle...
[CHECK_CYCLE] –ú–µ—Ç–æ–¥ get_referrals_for_order_check() –≤–µ—Ä–Ω—É–ª: X –∑–∞–ø–∏—Å–µ–π
[CHECK_CYCLE] –ë—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ X –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
[CHECK_1/X] –ü—Ä–æ–≤–µ—Ä—è–µ–º user_id=..., driver_id=...
[ORDERS_CHECK] –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è driver_id=...
[ORDERS_CHECK] Driver XXX: –ò–¢–û–ì–û –∑–∞–∫–∞–∑–æ–≤ = YYY
[CHECK_1/X] ‚úì Driver XXX: –ø–æ–ª—É—á–µ–Ω–æ YYY –∑–∞–∫–∞–∑–æ–≤
```

**–í–ê–ñ–ù–û:** –ï—Å–ª–∏ –≤–∏–¥–∏—à—å `[ORDERS_CHECK] Driver XXX: API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ!` - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç:
- –õ–∏–±–æ —É –≤–æ–¥–∏—Ç–µ–ª—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤
- –õ–∏–±–æ driver_id –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –õ–∏–±–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ API –∫–ª—é—á–∞

### 3. –î–µ–ø–ª–æ–π –Ω–∞ VPS

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏ —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
sudo systemctl stop order_checker
pkill -f bot.py

# 2. –û–±–Ω–æ–≤–∏ –∫–æ–¥
cd /path/to/tgbotkworkAlexzandr83
git pull  # –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª—ã

# 3. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
nohup python3 bot.py > bot.log 2>&1 &

# 4. –ó–∞–ø—É—Å—Ç–∏ order_checker
nohup python3 order_checker.py > order_checker_new.log 2>&1 &

# 5. –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏
tail -f order_checker_new.log
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–æ—Ç–∞

1. –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞ ‚Üí "‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" ‚Üí "üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É"
2. –í–≤–µ–¥–∏ —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–ª –∑–∞–∫–∞–∑—ã
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:
   - ‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑ –Ø–Ω–¥–µ–∫—Å –ü–∞—Ä–∫–∞ (–§–ò–û, —Å—Ç–∞—Ç—É—Å, –±–∞–ª–∞–Ω—Å)
   - ‚úÖ **"–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: XXX"** (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–∫–∞–∑—ã)
   - ‚úÖ –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö —Å –∏—Ö –∑–∞–∫–∞–∑–∞–º–∏

## –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0 –∑–∞–∫–∞–∑–æ–≤

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:

1. **–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ order_checker.log:**
```bash
grep "ORDERS_CHECK" order_checker.log | tail -50
```

2. **–ü—Ä–æ–≤–µ—Ä—å driver_id –≤ –ë–î:**
```bash
sqlite3 bot.db "SELECT user_id, phone_number, yandex_driver_id FROM users WHERE phone_number = '+79XXXXXXXXX'"
```

3. **–ü—Ä–æ–≤–µ—Ä—å API –∫–ª—é—á –≤—Ä—É—á–Ω—É—é:**
```bash
curl -X POST "https://fleet-api.taxi.yandex.net/v1/parks/driver-profiles/list" \
  -H "X-Park-ID: YOUR_PARK_ID" \
  -H "X-Client-ID: YOUR_CLIENT_ID" \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "query": {
      "park": {
        "id": "YOUR_PARK_ID"
      }
    },
    "limit": 10
  }'
```

4. **–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ API –∫–ª—é—á–∞ –≤ –Ø–Ω–¥–µ–∫—Å –ü–∞—Ä–∫–µ:**
   - –ó–∞–π–¥–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∫–∞
   - –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ API –∫–ª—é—á –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–≤–µ—Ä—å:
- `order_checker.log` - –≥–ª–∞–≤–Ω—ã–π –ª–æ–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–∫–∞–∑–æ–≤
- `bot.log` - –ª–æ–≥ –±–æ—Ç–∞
- –ë–î —á–µ—Ä–µ–∑ `sqlite3 bot.db`

---

**–í–µ—Ä—Å–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 2024-11-20
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- bot.py (—Å—Ç—Ä–æ–∫–∞ 271)
- yandex_park_api.py (–º–µ—Ç–æ–¥ get_driver_orders_count)
- order_checker.py (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + fallback)

